<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.16">
<meta name="author" content="Tony Kay">
<title>State Charts for Clojure(script)</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;-webkit-tap-highlight-color:transparent}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>State Charts for Clojure(script)</h1>
<div class="details">
<span id="author" class="author">Tony Kay</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_usage">1. Usage</a>
<ul class="sectlevel2">
<li><a href="#_basics">1.1. Basics</a></li>
</ul>
</li>
<li><a href="#_status">2. Status</a>
<ul class="sectlevel2">
<li><a href="#Goals">2.1. Goals and Extensibility</a></li>
</ul>
</li>
<li><a href="#_guide">3. Guide</a>
<ul class="sectlevel2">
<li><a href="#_terminology">3.1. Terminology</a></li>
<li><a href="#_data_models">3.2. Data Models</a></li>
<li><a href="#_transitions">3.3. Transitions</a></li>
<li><a href="#_event_processing">3.4. Event Processing</a>
<ul class="sectlevel3">
<li><a href="#_autonomous_execution">3.4.1. Autonomous Execution</a></li>
</ul>
</li>
<li><a href="#_execution">3.5. Execution</a></li>
<li><a href="#_working_memory_and_identity">3.6. Working Memory and Identity</a></li>
</ul>
</li>
<li><a href="#_relationship_to_scxml">4. Relationship to SCXML</a>
<ul class="sectlevel2">
<li><a href="#_related_work">4.1. Related Work</a></li>
<li><a href="#_conformance">4.2. Conformance</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>An implementation of state charts that use the SCXML
structure and semantics (as far as they are defined), without the need for XML.</p>
</div>
<div class="paragraph">
<p><span class="image"><a class="image" href="https://clojars.org/com.fulcrologic/statecharts"><img src="https://img.shields.io/clojars/v/com.fulcrologic/statecharts.svg" alt="statecharts"></a></span>
<span class="image"><a class="image" href="https://circleci.com/gh/fulcrologic/statecharts/tree/main"><img src="https://circleci.com/gh/fulcrologic/statecharts/tree/main.svg?style=svg" alt="CircleCI"></a></span></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_usage"><a class="anchor" href="#_usage"></a><a class="link" href="#_usage">1. Usage</a></h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_basics"><a class="anchor" href="#_basics"></a><a class="link" href="#_basics">1.1. Basics</a></h3>
<div class="paragraph">
<p>A statechart is defined as a (nested) map. Some of this content&#8217;s behavior is <a href="#Goals">configurable</a>.
The simplest setup is to use Clojure for the executable code and a simple data model that scopes
data to states.</p>
</div>
<div class="paragraph">
<p>To make it easier to write the maps there are functions for each element type in the
<code>com.fulcrologic.statecharts.elements</code> namespace, and it is recommended that you use these because some of
them validate their parameters and children.</p>
</div>
<div class="paragraph">
<p>Once you have a machine definition you need to create a session, which is just a running instance of the
machine.</p>
</div>
<div class="paragraph">
<p>Once you have a session, you can send events to it, and look at the content of the session (or store it, etc).</p>
</div>
<div class="paragraph">
<p>Here&#8217;s a traffic light example from the <code>src/examples</code> directory in this repository that
leverages parallel and compound states to simulate traffic lights with pedestrian signals:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">traffic-light</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.statecharts <span class="symbol">:as</span> sc]
    [com.fulcrologic.statecharts.state-machine <span class="symbol">:refer</span> [machine]]
    [com.fulcrologic.statecharts.elements <span class="symbol">:refer</span> [state parallel transition raise on-entry assign data-model]]
    [com.fulcrologic.statecharts.events <span class="symbol">:refer</span> [new-event]]
    [com.fulcrologic.statecharts.simple <span class="symbol">:refer</span> [new-simple-machine]]
    [com.fulcrologic.statecharts.protocols <span class="symbol">:as</span> sp]
    [com.fulcrologic.statecharts.util <span class="symbol">:refer</span> [extend-key]]))

(<span class="keyword">def</span> <span class="function">nk</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">(nk :a </span><span class="content">\&quot;</span><span class="content">b</span><span class="content">\&quot;</span><span class="content">) =&gt; :a/b
   (nk :a/b </span><span class="content">\&quot;</span><span class="content">c</span><span class="content">\&quot;</span><span class="content">) =&gt; :a.b/c</span><span class="delimiter">&quot;</span></span>
  extend-key)

(<span class="keyword">defn</span> <span class="function">traffic-signal</span> [id initial]
  (<span class="keyword">let</span> [red     (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>)
        yellow  (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">yellow</span><span class="delimiter">&quot;</span></span>)
        green   (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">green</span><span class="delimiter">&quot;</span></span>)
        initial (nk id (<span class="keyword">name</span> initial))]
    (state {<span class="symbol">:id</span>      id
            <span class="symbol">:initial</span> initial}
      (state {<span class="symbol">:id</span> red}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> green}))
      (state {<span class="symbol">:id</span> yellow}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> red}))
      (state {<span class="symbol">:id</span> green}
        (transition {<span class="symbol">:event</span>  <span class="symbol">:warn-traffic</span>
                     <span class="symbol">:target</span> yellow})))))

(<span class="keyword">defn</span> <span class="function">ped-signal</span> [id initial]
  (<span class="keyword">let</span> [red            (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>)
        flashing-white (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">flashing-white</span><span class="delimiter">&quot;</span></span>)
        white          (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">white</span><span class="delimiter">&quot;</span></span>)
        initial        (nk id (<span class="keyword">name</span> initial))]
    (state {<span class="symbol">:id</span>      id
            <span class="symbol">:initial</span> initial}
      (state {<span class="symbol">:id</span> red}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> white}))
      (state {<span class="symbol">:id</span> flashing-white}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> red}))
      (state {<span class="symbol">:id</span> white}
        (transition {<span class="symbol">:event</span> <span class="symbol">:warn-pedestrians</span> <span class="symbol">:target</span> flashing-white})))))

(<span class="keyword">def</span> <span class="function">traffic-lights</span>
  (machine {}
    (parallel {}
      (traffic-signal <span class="symbol">:east-west</span> <span class="symbol">:green</span>)
      (traffic-signal <span class="symbol">:north-south</span> <span class="symbol">:red</span>)

      (ped-signal <span class="symbol">:cross-ew</span> <span class="symbol">:red</span>)
      (ped-signal <span class="symbol">:cross-ns</span> <span class="symbol">:white</span>))))

(<span class="keyword">defn</span> <span class="function">show-states</span> [wmem]
  (<span class="keyword">println</span> (<span class="keyword">sort</span> (<span class="keyword">filter</span> #{<span class="symbol">:north-south/red</span>
                           <span class="symbol">:north-south/yellow</span>
                           <span class="symbol">:north-south/green</span>
                           <span class="symbol">:east-west/red</span>
                           <span class="symbol">:east-west/yellow</span>
                           <span class="symbol">:east-west/green</span>
                           <span class="symbol">:cross-ns/red</span>
                           <span class="symbol">:cross-ns/white</span>
                           <span class="symbol">:cross-ns/flashing-white</span>
                           <span class="symbol">:cross-ew/red</span>
                           <span class="symbol">:cross-ew/white</span>
                           <span class="symbol">:cross-ew/flashing-white</span>} (<span class="symbol">::sc/configuration</span> wmem)))))

(<span class="keyword">def</span> <span class="function">processor</span> (new-simple-machine traffic-lights {}))
(<span class="keyword">def</span> <span class="function">s0</span> (sp/start! processor <span class="integer">1</span>))
(show-states s0)
(<span class="keyword">def</span> <span class="function">s1</span> (sp/process-event! processor s0 (new-event <span class="symbol">:warn-pedestrians</span>)))
(show-states s1)
(<span class="keyword">def</span> <span class="function">s2</span> (sp/process-event! processor s1 (new-event <span class="symbol">:warn-traffic</span>)))
(show-states s2)
(<span class="keyword">def</span> <span class="function">s3</span> (sp/process-event! processor s2 (new-event <span class="symbol">:swap-flow</span>)))
(show-states s3)
(<span class="keyword">def</span> <span class="function">s4</span> (sp/process-event! processor s3 (new-event <span class="symbol">:warn-pedestrians</span>)))
(show-states s4)
(<span class="keyword">def</span> <span class="function">s5</span> (sp/process-event! processor s4 (new-event <span class="symbol">:warn-traffic</span>)))
(show-states s5)
(<span class="keyword">def</span> <span class="function">s6</span> (sp/process-event! processor s5 (new-event <span class="symbol">:swap-flow</span>)))
(show-states s6)</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you run the items in the comment block, you&#8217;ll see:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="symbol">:cross-ew/red</span> <span class="symbol">:cross-ns/white</span> <span class="symbol">:east-west/green</span> <span class="symbol">:north-south/red</span>)
(<span class="symbol">:cross-ew/red</span> <span class="symbol">:cross-ns/flashing-white</span> <span class="symbol">:east-west/green</span> <span class="symbol">:north-south/red</span>)
(<span class="symbol">:cross-ew/red</span> <span class="symbol">:cross-ns/flashing-white</span> <span class="symbol">:east-west/yellow</span> <span class="symbol">:north-south/red</span>)
(<span class="symbol">:cross-ew/white</span> <span class="symbol">:cross-ns/red</span> <span class="symbol">:east-west/red</span> <span class="symbol">:north-south/green</span>)
(<span class="symbol">:cross-ew/flashing-white</span> <span class="symbol">:cross-ns/red</span> <span class="symbol">:east-west/red</span> <span class="symbol">:north-south/green</span>)
(<span class="symbol">:cross-ew/flashing-white</span> <span class="symbol">:cross-ns/red</span> <span class="symbol">:east-west/red</span> <span class="symbol">:north-south/yellow</span>)
(<span class="symbol">:cross-ew/red</span> <span class="symbol">:cross-ns/white</span> <span class="symbol">:east-west/green</span> <span class="symbol">:north-south/red</span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>History support includes both shallow and deep. Here&#8217;s a shallow example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">history-sample</span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.statecharts.state-machine <span class="symbol">:refer</span> [machine]]
    [com.fulcrologic.statecharts.elements <span class="symbol">:refer</span> [state parallel transition on-entry final done-data
                                                  data-model log on-exit script history]]
    [com.fulcrologic.statecharts.events <span class="symbol">:refer</span> [new-event]]
    [com.fulcrologic.statecharts.simple <span class="symbol">:refer</span> [new-simple-machine]]
    [com.fulcrologic.statecharts.protocols <span class="symbol">:as</span> sp]
    [com.fulcrologic.statecharts.util <span class="symbol">:refer</span> [extend-key]]))

(<span class="keyword">def</span> <span class="function">sample</span>
  (machine {}
    (state {<span class="symbol">:id</span> <span class="symbol">:TOP</span>}
      (state {<span class="symbol">:id</span> <span class="symbol">:A</span>}
        (transition {<span class="symbol">:event</span> <span class="symbol">:top</span> <span class="symbol">:target</span> <span class="symbol">:B</span>}))
      (state {<span class="symbol">:id</span> <span class="symbol">:B</span>}
        <span class="comment">;; Could transition to :C, but that won't restore history.</span>
        <span class="comment">;; Transitioning to (one of) the history nodes in C</span>
        <span class="comment">;; directly restores history (you can have more than</span>
        <span class="comment">;; one because you might want different &quot;default&quot; targets</span>
        <span class="comment">;; for when there is no history).</span>
        (transition {<span class="symbol">:event</span> <span class="symbol">:top</span> <span class="symbol">:target</span> <span class="symbol">:Ch</span>}))
      (state {<span class="symbol">:id</span> <span class="symbol">:C</span>}
        (transition {<span class="symbol">:event</span> <span class="symbol">:top</span> <span class="symbol">:target</span> <span class="symbol">:A</span>})
        (history {<span class="symbol">:id</span> <span class="symbol">:Ch</span>}
          (transition {<span class="symbol">:target</span> <span class="symbol">:C1</span>}))
        (state {<span class="symbol">:id</span> <span class="symbol">:C1</span>}
          (transition {<span class="symbol">:event</span> <span class="symbol">:sub</span> <span class="symbol">:target</span> <span class="symbol">:C2</span>}))
        (state {<span class="symbol">:id</span> <span class="symbol">:C2</span>}
          (transition {<span class="symbol">:event</span> <span class="symbol">:sub</span> <span class="symbol">:target</span> <span class="symbol">:C1</span>}))))))

(<span class="keyword">def</span> <span class="function">processor</span> (new-simple-machine sample {}))

(<span class="keyword">def</span> <span class="function">s0</span> (sp/start! processor <span class="integer">1</span>))
<span class="comment">;; :TOP :A</span>

(<span class="keyword">def</span> <span class="function">s1</span> (sp/process-event! processor s0 (new-event <span class="symbol">:top</span>)))
<span class="comment">;; :TOP :B</span>

(<span class="keyword">def</span> <span class="function">s2</span> (sp/process-event! processor s1 (new-event <span class="symbol">:top</span>)))
<span class="comment">;; :TOP :C :C1</span>

(<span class="keyword">def</span> <span class="function">s3</span> (sp/process-event! processor s2 (new-event <span class="symbol">:sub</span>)))
<span class="comment">;; :TOP :C :C2</span>

(<span class="keyword">def</span> <span class="function">s4</span> (sp/process-event! processor s3 (new-event <span class="symbol">:top</span>)))
<span class="comment">;; :TOP :A</span>

(<span class="keyword">def</span> <span class="function">s5</span> (sp/process-event! processor s4 (new-event <span class="symbol">:top</span>)))
<span class="comment">;; :TOP :B</span>

(<span class="keyword">def</span> <span class="function">s6</span> (sp/process-event! processor s5 (new-event <span class="symbol">:top</span>)))
<span class="comment">;; :TOP :C :C2 (history remembered)</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>See the <a href="https://www.w3.org/TR/2015/REC-scxml-20150901/">SCXML spec</a> for how to structure elements. The structure and naming are kept close to that spec for easy
cross-referencing with its documentation.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_status"><a class="anchor" href="#_status"></a><a class="link" href="#_status">2. Status</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>ALPHA.</p>
</div>
<div class="paragraph">
<p>The state chart definition (machine and elements) are API stable, as is the underlying base algorithm (though
it may have bugs).</p>
</div>
<div class="paragraph">
<p>The API is 90+% stable, but may undergo minor changes to accomodate design of <code>invoke</code> and (expanded) <code>send</code> elements.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Implemented</p>
<div class="ulist">
<ul>
<li>
<p>DataModel, ExecutionModel, and EventQueue abstractions, along with a simple implementation.</p>
<div class="ulist">
<ul>
<li>
<p>Late and early data model binding.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Compound, parallel, atomic, initial, and final states</p>
<div class="ulist">
<ul>
<li>
<p>on-entry, on-exit</p>
</li>
<li>
<p>History (deep and shallow). Multiple nodes allowed, with default transitions (for when there is no history).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Transitions</p>
<div class="ulist">
<ul>
<li>
<p>Eventless transitions</p>
</li>
<li>
<p>Guards</p>
</li>
<li>
<p>Executable content when taking a transition</p>
</li>
</ul>
</div>
</li>
<li>
<p>Executable content elements:</p>
<div class="ulist">
<ul>
<li>
<p>Script, raise, send, log, assign, and done-data.</p>
</li>
<li>
<p>Executable content elements are extensible (you can make your own kind)</p>
</li>
</ul>
</div>
</li>
<li>
<p>Simple dev-mode SCXML &#8594; CLJC conversion utility (see src/dev).</p>
</li>
</ul>
</div>
</li>
<li>
<p>Not yet implemented</p>
<div class="ulist">
<ul>
<li>
<p>Invoke external processes.</p>
</li>
<li>
<p>Send events to arbitrary other sessions/services (easy add-on by user)</p>
</li>
<li>
<p>Additional Executable content:</p>
<div class="ulist">
<ul>
<li>
<p>The other (e.g. if/else) SCXML flow control elements. (may not ever bother, but this is extensible, so you can easily do so)</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>See Conformance.adoc at the root of this repository for notes on
decisions that might affect exact conformance to the standard.</p>
</div>
<div class="sect2">
<h3 id="Goals"><a class="anchor" href="#Goals"></a><a class="link" href="#Goals">2.1. Goals and Extensibility</a></h3>
<div class="paragraph">
<p>This library supports a lot of flexibility, and has many long-term goals:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Compatible with distributed systems. For example a cluster might run long-lived state machine sessions that
can be serviced by any node of the custer.</p>
</li>
<li>
<p>State machine definitions can be versioned.</p>
</li>
<li>
<p>Everything <strong>can</strong> be made to be serializable (including the code in the machine).</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Thus you can define (via protocols):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>How to interpret the executable code of the state machine (e.g. on-exit, cond, etc.). You could, for example,
use strings for those, and Javascript or SCI to interpret them (making the machine completely serializable).</p>
</li>
<li>
<p>How the data model of the states work. You can, for example, hook the data model into Fulcro, Reagent, Datomic, Datascript, etc.</p>
</li>
<li>
<p>The implementation of the event queue. This allows you to generate state machines that know how
to send events to each other, can be distributed, etc.  It is necessary to make this part of the internals because
the state charts support sending events from within state code, which as we mentioned above, could be interpreted
by your own execution model and may not actually be Clojure(script).</p>
</li>
<li>
<p>The actual state chart processing semantics/algorithm. A version of the W3C 2015-09-01 recommendation for SCXML is provided
as a default.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>However, it would be a real hassle if you had to set up all of that stuff just to get what many people want:
A statechart that can run in CLJC, using Clojure code, and a functional interface where you can manually
send events to the machine. Thus, a reasonable default implementation is provided for the above, and
it is simple to expand this to meet your needs.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_guide"><a class="anchor" href="#_guide"></a><a class="link" href="#_guide">3. Guide</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>First some very important notes:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Every node in a state chart has a UNIQUE ID. These IDs are autogenerated if you do not supply them.</p>
</li>
<li>
<p>Most of the "executable content" elements described in the SCXML standard (e.g. <code>&lt;if&gt;</code>) are simply
collapsed into the <code>script</code> node.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_terminology"><a class="anchor" href="#_terminology"></a><a class="link" href="#_terminology">3.1. Terminology</a></h3>
<div class="dlist">
<dl>
<dt class="hdlist1">Atomic State</dt>
<dd>
<p>A state that does not have substates.</p>
</dd>
<dt class="hdlist1">Compound State</dt>
<dd>
<p>A state that has child <strong>states</strong>, where at most <strong>one</strong> child is active at any given time.</p>
</dd>
<dt class="hdlist1">Parallel State</dt>
<dd>
<p>A state that has more than one compound substate, all of which is active at the same time, and
thus have a child state that is active.</p>
</dd>
<dt class="hdlist1">Configuration</dt>
<dd>
<p>When used in the context of a state chart, the configuration is the list of all active states. A
state is active if it or ANY of its children are active. Thus, a parallel machine with hierarchical states may
have a rather large set of IDs in its current configuration.</p>
</dd>
<dt class="hdlist1">Working Memory</dt>
<dd>
<p>A map of data that contains the current configuration of the state machine, and other information
necessary to know its current full state (which states have had their data model initialized, possible data model
tracking, etc.).</p>
</dd>
<dt class="hdlist1">DataModel</dt>
<dd>
<p>An implementation of the data model protocol defines how the data model of your chart works. The simple
implementation places the data in Working Memory, and treats lookups in a scoped fashion.</p>
</dd>
<dt class="hdlist1">ExecutionModel</dt>
<dd>
<p>An implementation of this protocol is handed the expressions that are included on the state chart, and
chooses how to run them. A default implementation requires that they be Clojure <code>(fn [env data])</code>, and simply calls them
with the contextual data for their location.</p>
</dd>
<dt class="hdlist1">External Event</dt>
<dd>
<p>An event that came from the external API, either by you calling <code>process-event</code> or some other
actor code doing so (invocations, sends from external machines, etc.).</p>
</dd>
<dt class="hdlist1">Internal Event</dt>
<dd>
<p>An event that came from the session that will process it. These come from the
machine implementation itself (e.g. done evens) and from you using the <code>raise</code> element in an
executable content position.</p>
</dd>
<dt class="hdlist1">EventQueue</dt>
<dd>
<p>A FIFO queue for external event delivery. The event queue is responsible for holding onto pending
External Events to "self", possibly other statechart sessions (instances of other machines),
remote services (e.g. send an email), and for delayed delivery. The default implementation is a "manually polled" queue
that does <strong>not</strong> support most of
these features, and the delayed event delivery is manual (e.g. you have to poll it, or ask it when the next one should
happen and start a timer/thread). Creating a system that runs the loop and does the timed delivery is typically
how you would use these in a more serious/production environment.</p>
</dd>
<dt class="hdlist1">Processor</dt>
<dd>
<p>An implementation of the statechart algorithm. This library comes with an implementation that follows
(as closely as possible) the SCXML recommended standard from 2015. You may provide your own.</p>
</dd>
<dt class="hdlist1">Session</dt>
<dd>
<p>The combination of the content of the DataModel and Working Memory. I.e. all of the data you&#8217;d need in order
to resume working from where you last left off. Sessions typically have a unique ID, which could be used to store
sessions into durable storage when they are "idle", and are used for cross-session events.</p>
</dd>
<dt class="hdlist1">Conditional Element</dt>
<dd>
<p>In statecharts there is a node type (represented as a diamond) that represents a state in which the machine
never "rests", but instead immediately transitions to another node based on predicate expressions. In this
library (and SCXML) this is modelled with a state that has more than one transition, NONE of which have
and <code>:event</code> qualifier (meaning they are exited as soon as they are entered, assuming there is a valid transition).</p>
</dd>
</dl>
</div>
</div>
<div class="sect2">
<h3 id="_data_models"><a class="anchor" href="#_data_models"></a><a class="link" href="#_data_models">3.2. Data Models</a></h3>
<div class="paragraph">
<p>The SCXML specification allows the implementation quite a bit of latitude in the interpretation of the chart&#8217;s
data model. You could define scopes that nest, one global map of data that is visible everywhere, or hook your
data model to an external database.</p>
</div>
<div class="paragraph">
<p>See the docstrings in the <code>protocols</code> namespace.</p>
</div>
</div>
<div class="sect2">
<h3 id="_transitions"><a class="anchor" href="#_transitions"></a><a class="link" href="#_transitions">3.3. Transitions</a></h3>
<div class="paragraph">
<p>A state can have any number of transition elements. These are tested <strong>in order</strong> of appearance, and the
first transition that matches the current circumstance is taken. Transitions are <strong>enabled</strong> when:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Their <code>cond</code> (if present) evaluates to true AND</p>
</li>
<li>
<p>Their <code>event</code> (if present) matches the current event&#8217;s name (See event name matching)</p>
</li>
<li>
<p>OR neither are present.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An "eventless" transition without a <code>:cond</code> is always enabled. Condition states can be modelled using such
transitions. For example, this
is a conditional state that when entered will immediately transition to either state :X or :Y, depending
on the result of the first transition&#8217;s condition expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(state {<span class="symbol">:id</span> <span class="symbol">:Z</span>}
  (transition {<span class="symbol">:cond</span> positive-balance? <span class="symbol">:target</span> <span class="symbol">:X</span>})
  (transition {<span class="symbol">:target</span> <span class="symbol">:Y</span>}))</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_event_processing"><a class="anchor" href="#_event_processing"></a><a class="link" href="#_event_processing">3.4. Event Processing</a></h3>
<div class="paragraph">
<p>In a fully-fleshed system your event queue would have a corresponding runtime story, where <code>process-event</code> was
automatically called on the correct machine/session/invocation/service when an event is available. As such,
and event queue might be distributed and durable (e.g. using Kafka or the like), or might simply be something
that runs in-core (a core.async <code>go-loop</code>).</p>
</div>
<div class="paragraph">
<p>The "simple" model that is provided with this library is an in-memory queue, with <strong>no</strong> automatic processing
at all. If you want to support events that come from outside of the machine via the queue, then you have
to create a loop that polls the queue and calls <code>process-event!</code>.  If you do this, then event the
delayed event delivery will work, as long as your code watches for the delayed events to appear on the queue.</p>
</div>
<div class="sect3">
<h4 id="_autonomous_execution"><a class="anchor" href="#_autonomous_execution"></a><a class="link" href="#_autonomous_execution">3.4.1. Autonomous Execution</a></h4>
<div class="paragraph">
<p>You can, of course, write your own "event loop". The library comes with a core.async event queue that works
in conjunction with the simple model to provide an event loop that will automatically process events as they come
in, and will allow the machine to send itself external events (usually done in order to get a delay). Note that the
<code>raise</code> element does not use the external queue, but also does not provide delays.</p>
</div>
<div class="paragraph">
<p>Below is an example of using the core.async queue to run a traffic light that
automatically changes over time:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure">(<span class="keyword">ns</span> <span class="namespace">traffic-light-async</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">A demo that uses the core.async queue to demonstrate a running machine that can just be
   sent events and mutates in place (and handles timers in CLJC) via core.async.</span><span class="delimiter">&quot;</span></span>
  (<span class="symbol">:require</span>
    [com.fulcrologic.statecharts <span class="symbol">:as</span> sc]
    [com.fulcrologic.statecharts.state-machine <span class="symbol">:refer</span> [machine]]
    [com.fulcrologic.statecharts.elements <span class="symbol">:refer</span> [state parallel transition raise on-entry assign data-model
                                                  Send]]
    [com.fulcrologic.statecharts.events <span class="symbol">:refer</span> [new-event]]
    [com.fulcrologic.statecharts.simple <span class="symbol">:refer</span> [new-simple-machine]]
    [com.fulcrologic.statecharts.protocols <span class="symbol">:as</span> sp]
    [com.fulcrologic.statecharts.event-queue.core-async-queue <span class="symbol">:as</span> aq]
    [com.fulcrologic.statecharts.simple <span class="symbol">:as</span> simple]
    [com.fulcrologic.statecharts.event-queue.core-async-queue <span class="symbol">:as</span> aq]
    [com.fulcrologic.statecharts.util <span class="symbol">:refer</span> [extend-key]]
    [com.fulcrologic.statecharts.events <span class="symbol">:as</span> evts]))

(<span class="keyword">def</span> <span class="function">nk</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">(nk :a </span><span class="content">\&quot;</span><span class="content">b</span><span class="content">\&quot;</span><span class="content">) =&gt; :a/b
   (nk :a/b </span><span class="content">\&quot;</span><span class="content">c</span><span class="content">\&quot;</span><span class="content">) =&gt; :a.b/c</span><span class="delimiter">&quot;</span></span>
  extend-key)

(<span class="keyword">def</span> <span class="function">flow-time</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">How long to wait before flashing ped warning</span><span class="delimiter">&quot;</span></span> <span class="integer">2000</span>)
(<span class="keyword">def</span> <span class="function">flashing-white-time</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">How long do we warn peds?</span><span class="delimiter">&quot;</span></span> <span class="integer">500</span>)
(<span class="keyword">def</span> <span class="function">yellow-time</span> <span class="string"><span class="delimiter">&quot;</span><span class="content">How long do we warn cars</span><span class="delimiter">&quot;</span></span> <span class="integer">200</span>)

(<span class="keyword">defn</span> <span class="function">timer</span> []
  (state {<span class="symbol">:id</span> <span class="symbol">:timer-control</span>}
    (state {<span class="symbol">:id</span> <span class="symbol">:timing-flow</span>}
      (transition {<span class="symbol">:event</span>  <span class="symbol">:warn-pedestrians</span>
                   <span class="symbol">:target</span> <span class="symbol">:timing-ped-warning</span>})
      (on-entry {}
        (Send {<span class="symbol">:event</span> (evts/new-event <span class="symbol">:warn-pedestrians</span>)
               <span class="symbol">:delay</span> flow-time})))
    (state {<span class="symbol">:id</span> <span class="symbol">:timing-ped-warning</span>}
      (transition {<span class="symbol">:event</span>  <span class="symbol">:warn-traffic</span>
                   <span class="symbol">:target</span> <span class="symbol">:timing-yellow</span>})
      (on-entry {}
        (Send {<span class="symbol">:event</span> (evts/new-event <span class="symbol">:warn-traffic</span>)
               <span class="symbol">:delay</span> flashing-white-time})))
    (state {<span class="symbol">:id</span> <span class="symbol">:timing-yellow</span>}
      (transition {<span class="symbol">:event</span>  <span class="symbol">:swap-flow</span>
                   <span class="symbol">:target</span> <span class="symbol">:timing-flow</span>})
      (on-entry {}
        (Send {<span class="symbol">:event</span> (evts/new-event <span class="symbol">:swap-flow</span>)
               <span class="symbol">:delay</span> yellow-time})))))

(<span class="keyword">defn</span> <span class="function">traffic-signal</span> [id initial]
  (<span class="keyword">let</span> [red     (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>)
        yellow  (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">yellow</span><span class="delimiter">&quot;</span></span>)
        green   (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">green</span><span class="delimiter">&quot;</span></span>)
        initial (nk id (<span class="keyword">name</span> initial))]
    (state {<span class="symbol">:id</span>      id
            <span class="symbol">:initial</span> initial}
      (state {<span class="symbol">:id</span> red}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> green}))
      (state {<span class="symbol">:id</span> yellow}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> red}))
      (state {<span class="symbol">:id</span> green}
        (transition {<span class="symbol">:event</span>  <span class="symbol">:warn-traffic</span>
                     <span class="symbol">:target</span> yellow})))))

(<span class="keyword">defn</span> <span class="function">ped-signal</span> [id initial]
  (<span class="keyword">let</span> [red            (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">red</span><span class="delimiter">&quot;</span></span>)
        flashing-white (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">flashing-white</span><span class="delimiter">&quot;</span></span>)
        white          (nk id <span class="string"><span class="delimiter">&quot;</span><span class="content">white</span><span class="delimiter">&quot;</span></span>)
        initial        (nk id (<span class="keyword">name</span> initial))]
    (state {<span class="symbol">:id</span>      id
            <span class="symbol">:initial</span> initial}
      (state {<span class="symbol">:id</span> red}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> white}))
      (state {<span class="symbol">:id</span> flashing-white}
        (transition {<span class="symbol">:event</span> <span class="symbol">:swap-flow</span> <span class="symbol">:target</span> red}))
      (state {<span class="symbol">:id</span> white}
        (transition {<span class="symbol">:event</span> <span class="symbol">:warn-pedestrians</span> <span class="symbol">:target</span> flashing-white})))))

(<span class="keyword">def</span> <span class="function">traffic-lights</span>
  (machine {}
    (parallel {}
      (timer)

      (traffic-signal <span class="symbol">:east-west</span> <span class="symbol">:green</span>)
      (traffic-signal <span class="symbol">:north-south</span> <span class="symbol">:red</span>)

      (ped-signal <span class="symbol">:cross-ew</span> <span class="symbol">:red</span>)
      (ped-signal <span class="symbol">:cross-ns</span> <span class="symbol">:white</span>))))

(<span class="keyword">defn</span> <span class="function">show-states</span> [wmem]
  (<span class="keyword">println</span> (<span class="keyword">sort</span> (<span class="keyword">filter</span> #{<span class="symbol">:north-south/red</span>
                           <span class="symbol">:north-south/yellow</span>
                           <span class="symbol">:north-south/green</span>
                           <span class="symbol">:east-west/red</span>
                           <span class="symbol">:east-west/yellow</span>
                           <span class="symbol">:east-west/green</span>
                           <span class="symbol">:cross-ns/red</span>
                           <span class="symbol">:cross-ns/white</span>
                           <span class="symbol">:cross-ns/flashing-white</span>
                           <span class="symbol">:cross-ew/red</span>
                           <span class="symbol">:cross-ew/white</span>
                           <span class="symbol">:cross-ew/flashing-white</span>} (<span class="symbol">::sc/configuration</span> wmem)))))

(<span class="keyword">comment</span>

  (<span class="keyword">def</span> <span class="function">session-id</span> <span class="integer">1</span>)
  (<span class="keyword">def</span> <span class="function">queue</span> (aq/new-async-queue))
  (<span class="keyword">def</span> <span class="function">processor</span> (simple/new-simple-machine traffic-lights {<span class="symbol">:event-queue</span> queue}))
  (<span class="keyword">def</span> <span class="function">wmem</span> (<span class="keyword">let</span> [a (<span class="keyword">atom</span> {})] (<span class="keyword">add-watch</span> a <span class="symbol">:printer</span> (<span class="keyword">fn</span> [_ _ _ n] (show-states n))) a))
  (aq/run-event-loop! processor wmem session-id {})         <span class="comment">; should see the state changing with the timers</span>

  <span class="comment">;; Tell the state machine to exit abruptly</span>
  (sp/send! queue {<span class="symbol">:target</span> session-id
                   <span class="symbol">:event</span>  evts/cancel-event}))</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<div class="title">Note</div>
</td>
<td class="content">
The <code>send</code> element has a <code>Send</code> alias so you can avoid shadowing the Clojure function.
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_execution"><a class="anchor" href="#_execution"></a><a class="link" href="#_execution">3.5. Execution</a></h3>
<div class="paragraph">
<p>Most people will probably just use the CLJCExecutionModel, which lets you write executable content
in CLJC as lambdas:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; Use `data` to compute when this transition is &quot;enabled&quot;</span>
(transition {<span class="symbol">:event</span> <span class="symbol">:a</span> <span class="symbol">:cond</span> (<span class="keyword">fn</span> [env data] (your-predicate data))}
  <span class="comment">;; Run some arbitrary code on this transition</span>
  (script {<span class="symbol">:expr</span> (<span class="keyword">fn</span> [env data] <span class="keyword">..</span><span class="keyword">.</span>)}))</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is a macro version of the <code>script</code> element called <code>sfn</code> that can be used as a shorthand for
script elements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; Use `data` to compute when this transition is &quot;enabled&quot;</span>
(transition {<span class="symbol">:event</span> <span class="symbol">:a</span> <span class="symbol">:cond</span> (<span class="keyword">fn</span> [env data] (your-predicate data))}
  <span class="comment">;; Run some arbitrary code on this transition</span>
  (sfn [env data] <span class="keyword">..</span><span class="keyword">.</span>)))</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_working_memory_and_identity"><a class="anchor" href="#_working_memory_and_identity"></a><a class="link" href="#_working_memory_and_identity">3.6. Working Memory and Identity</a></h3>
<div class="paragraph">
<p>The working memory of the state machine is plain EDN and contains no code.
It is serializable by nippy, transit, etc. Therefore, you can easily save
an active state machine by value into any data store. The value
is intended to be as small as possible so that storage can be efficient.</p>
</div>
<div class="paragraph">
<p>Every active state machine is assigned a ID on creation (which you
can override via <code>initialize</code>). This is intended as part of the story to
allow you to coordinate external event sources with working with
instances of machines that are archived in durable storage while idle.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_relationship_to_scxml"><a class="anchor" href="#_relationship_to_scxml"></a><a class="link" href="#_relationship_to_scxml">4. Relationship to SCXML</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>This library&#8217;s internal implementation follows (as closely as possible) the official
<a href="https://www.w3.org/TR/2015/REC-scxml-20150901/#AlgorithmforSCXMLInterpretation">State Chart XML Algorithm</a>. In fact,
much of the implementation uses internal volatiles in order to match the imperative style of that doc for easier
comparison and avoidance of bugs.</p>
</div>
<div class="paragraph">
<p>The actual structure of the live CLJC data used to represent machines also closely mimics
the structure described there, but with some differences for convenient use in CLJC.</p>
</div>
<div class="paragraph">
<p>Specifically, executable content is <strong>still</strong> treated as <strong>data</strong>, but the XML nodes that
are described in the standard do <strong>not</strong> exist in this library, because a conformant
XML reader (which would need to be aware of the target execution model) can easily
translate such nodes into the target data representation (even if that target
representation is script strings).</p>
</div>
<div class="paragraph">
<p>Some of the data model elements are also abbreviated in a similar manner. See
the docstrings for details.</p>
</div>
<div class="paragraph">
<p>Thus, if you are trying to read SCXML documents you will need to write (or find) an
XML reader that can do this interpretation.</p>
</div>
<div class="paragraph">
<p>For example, an XML reader that targets <a href="https://github.com/babashka/sci">sci</a> (the
Clojure interpreter) might convert the XML (where <code>a</code> and <code>do-something</code> are implied
values in the data and excution model):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;if</span> <span class="attribute-name">cond</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">(= 1 a)</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  (let [b (inc a)]
    (do-something b))
<span class="tag">&lt;/if&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>into (scope and args still determined by the execution model selected):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="clojure"><span class="comment">;; String-based interpretation</span>
(script {<span class="symbol">:expr</span>
  <span class="string"><span class="delimiter">&quot;</span><span class="content">(if (= 1 a)
     (let [b (inc a)]
       (do-something b)))</span><span class="delimiter">&quot;</span></span>})

<span class="comment">;; OR eval-based</span>
(script {<span class="symbol">:expr</span>
  '(<span class="keyword">if</span> (<span class="keyword">=</span> <span class="integer">1</span> a)
     (<span class="keyword">let</span> [b (<span class="keyword">inc</span> a)]
       (do-something b)))})

<span class="comment">;; OR functional</span>
(script {<span class="symbol">:expr</span> (<span class="keyword">fn</span> [env {<span class="symbol">:keys</span> [a]}]
                  (<span class="keyword">if</span> (<span class="keyword">=</span> <span class="integer">1</span> a)
                    (<span class="keyword">let</span> [b (<span class="keyword">inc</span> a)]
                      (do-something b))))})</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you&#8217;re using XML tools to generate you machines, though, it&#8217;s probably easiest to use
<code>script</code> tags to begin with.</p>
</div>
<div class="sect2">
<h3 id="_related_work"><a class="anchor" href="#_related_work"></a><a class="link" href="#_related_work">4.1. Related Work</a></h3>
<div class="paragraph">
<p>The primary alternative to this library is <a href="https://github.com/lucywang000/clj-statecharts">clj-statecharts</a>,
which is a fine library modelled after xstate.</p>
</div>
<div class="paragraph">
<p>This library exists for the following reasons:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>At the time this library was created, <a href="https://github.com/lucywang000/clj-statecharts/">clj-statecharts</a> was missing features. In particular history nodes,
which we needed. I looked at clj-statecharts in order to try to add history, but some of the internal
decisions made it more difficult to add (with correct semantics) and the Eclipse license made it less
appealing for internal customization as a base in commercial software (see <a href="https://www.juxt.pro/blog/prefer-mit" class="bare">https://www.juxt.pro/blog/prefer-mit</a>).</p>
</li>
<li>
<p>To create an SCXML-like implementation that uses the algorithm defined
in the W3C Recommended document, and can (grow to) run (with minor transformations) SCXML docs that are
targeted to Clojure with the semantics defined there (such as they are).</p>
</li>
<li>
<p>To define more refined abstract mechanisms such that the state charts can be associated to long-lived things
(such as a monetary transaction that happens over time) and
be customized to interface with things like durable queues for events (e.g. AWS SQS) and
reliable timers.</p>
</li>
<li>
<p>MIT licensing instead of Eclipse.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Other related libraries and implementations:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://xstate.js.org/">XState</a> : Javascript. Could be used from CLJS.</p>
</li>
<li>
<p><a href="https://commons.apache.org/proper/commons-scxml/">Apache SCXML</a> : Stateful and imperative. Requires writing classes. Requires you use XML.</p>
</li>
<li>
<p><a href="https://github.com/fulcrologic/fulcro/blob/develop/src/main/com/fulcrologic/fulcro/ui_state_machines.cljc">Fulcro UI State Machines</a>
: A finite state machine namespace (part of Fulcro) that is tightly coupled to Fulcro&#8217;s needs (full stack operation in the context of
Fulcro UI and I/O).</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_conformance"><a class="anchor" href="#_conformance"></a><a class="link" href="#_conformance">4.2. Conformance</a></h3>
<div class="paragraph">
<p>This library was written using the reference implementation described in
the <a href="https://www.w3.org/TR/scxml">SCXML standard</a>, but without the requirement
that the machine be written in XML.</p>
</div>
<div class="paragraph">
<p>Any deviation from the standard (as far as general operation of state transitions, order
of execution of entry/exit, etc.) should be considered a bug. Note that it is possible
for a bugfix in this library to change the behavior of your code (if you wrote it in
a way that depends on the misbehavior); therefore, even though
this library does not intend to make breaking changes, it is possible that a bugfix could affect
your code&#8217;s operation.</p>
</div>
<div class="paragraph">
<p>If future versions of the standard are released that cause incompatible changes, then
this library will add a new namespace for that new standard (not break versioning).</p>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-12-15 15:58:16 -0800
</div>
</div>
</body>
</html>